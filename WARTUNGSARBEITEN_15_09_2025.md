# üöß Wartungsarbeiten 15.09.2025 - Rollen-System Update

## üìã Checkliste f√ºr den 15.09.2025

### üîí 1. Login-Sperre aktivieren
- [ ] **LoginBlocker aktivieren** in Login-Seite einbauen
- [ ] **Komponente:** `/src/components/LoginBlocker.tsx` (bereits erstellt)
- [ ] **Aktivierung:** LoginBlocker in `/src/app/login/page.tsx` einbauen

### üë• 2. Benutzerrollen umstellen

#### üéØ Finale Rollen-Struktur (Best-of-Both Hybrid):

**üëë Globale Rollen (Plattform-Ebene):**
- `SUPER_ADMIN`: Entwickler/Betreiber (admin@rwk-einbeck.de) - Vollzugriff auf alles
- `SYSTEM_ADMIN`: System-Administration (Zukunft) - Technische Wartung
- `DATA_MANAGER`: Daten-Import/Export (Zukunft) - Migrations-Aufgaben

**üéØ Kreisverband-Rollen (KV-Ebene):**
- `KV_WETTKAMPFLEITER`: Vollzugriff auf RWK & KM im eigenen KV
- `KV_KM_ORGA`: Hilfspersonal, Vollzugriff auf KM-Modul
- `KV_PRESSEWART`: Schreibzugriff auf News, Lesezugriff auf Wettk√§mpfe
- `KV_KAMPFRICHTER`: KM-Ergebnisse erfassen, Startlisten verwalten

**üè¢ Vereins-Rollen (Club-Ebene - Sofort):**
- `VORSTAND`: Vollzugriff auf alle Module des eigenen Vereins
- `SPORTLEITER`: RWK/KM-Meldungen, Lesezugriff auf Mitglieder f√ºr Mannschaftsplanung
- `KASSENWART`: Vollzugriff auf Finanzen & Mitglieder (inkl. SEPA)
- `SCHRIFTFUEHRER`: Vollzugriff auf Vereinsrecht (Protokolle, Wahlen), Lesezugriff auf Mitglieder

**üéì Erweiterte Vereins-Rollen (Phase 2):**
- `JUGENDWART`: Jugend-Mitglieder verwalten, Ausbildungen planen
- `DAMENWART`: Damen-spezifische Aktivit√§ten und Events
- `ZEUGWART`: Waffen & Ausr√ºstung verwalten, Inventar f√ºhren
- `PRESSEWART`: Vereins-News schreiben, Berichte erstellen
- `TRAINER`: Ausbildungen durchf√ºhren, Lizenzen verwalten
- `AUSBILDER`: Fortgeschrittene Schulungen, Pr√ºfungen abnehmen
- `VEREINSSCHUETZE`: Basis-Mitglied, eigene Daten einsehen
- `EHRENMITGLIED`: Lesezugriff auf Vereinsgeschichte und Ehrungen

**üåç Skalierungs-Rollen (Zukunft):**
- `VERBANDSLEITER`: Multi-KV-Verwaltung f√ºr andere Verb√§nde
- `LANDESSCHIESSWART`: Landes-Ebene f√ºr DSB-Integration

#### Rollen-√Ñnderungen:
- [ ] **Datenbank-Migration:** `user_permissions` Collection auf neue Struktur umstellen (von `role: 'vereinsvertreter'` zu `clubRoles: { 'clubId': 'sportleiter' }`).
- [ ] **Marcel (marcel.buenger@gmx.de):** Bleibt `vereinsvertreter`, wird sp√§ter zu neuen Rollen migriert.
- [ ] **Bestehende Vereinsvertreter:** In die neue `clubRoles`-Struktur migrieren, z.B. als `sportleiter`.
- [ ] **Bestehende KM-Orga:** In die neue `kvRoles`-Struktur migrieren, z.B. als `kv_km_orga`.

### üîê 3. URL-Sicherung implementieren

#### Vereinssoftware-Seiten absichern:
- [ ] `/src/app/vereinssoftware/page.tsx` - Hauptseite
- [ ] `/src/app/vereinssoftware/mitglieder/page.tsx`
- [ ] `/src/app/vereinssoftware/beitraege/page.tsx`
- [ ] `/src/app/vereinssoftware/finanzen/page.tsx`
- [ ] `/src/app/vereinssoftware/jubilaeen/page.tsx`
- [ ] `/src/app/vereinssoftware/lizenzen/page.tsx`
- [ ] `/src/app/vereinssoftware/aufgaben/page.tsx`
- [ ] `/src/app/vereinssoftware/vereinsrecht_protokolle/page.tsx`

#### Code-Template f√ºr Berechtigungspr√ºfung:
```typescript
// Am Anfang jeder gesch√ºtzten Seite (Client Component)
import { useAuth } from '@/hooks/useAuth'; // Beispielhafter Hook

const { user, userPermissions } = useAuth();
const clubId = 'aktueller-vereins-kontext'; // aus URL oder State

const hasAccess = (allowedRoles) => {
  if (userPermissions?.platformRole === 'SUPER_ADMIN') return true;
  const userRole = userPermissions?.clubRoles?.[clubId];
  return userRole && allowedRoles.includes(userRole);
};

if (!hasAccess(['vorstand', 'kassenwart'])) {
  return <AccessDeniedComponent />;
}
```

### üõ°Ô∏è 4. Firebase Security Rules Revolution

#### üîß Helper-Funktionen (3-Ebenen-Architektur):
```javascript
// üëë Globale Rollen
function isSuperAdmin() { return request.auth.token.email == 'admin@rwk-einbeck.de'; }
function isSystemAdmin() { return getUserRole() == 'system_admin'; }
function isDataManager() { return getUserRole() == 'data_manager'; }

// üéØ KV-Rollen
function isKvWettkampfleiter(kvId) { return getUserKvRole(kvId) == 'kv_wettkampfleiter'; }
function isKvKmOrga(kvId) { return getUserKvRole(kvId) == 'kv_km_orga'; }
function isKvPressewart(kvId) { return getUserKvRole(kvId) == 'kv_pressewart'; }
function isKvKampfrichter(kvId) { return getUserKvRole(kvId) == 'kv_kampfrichter'; }

// üè¢ Vereins-Rollen (Granular)
function isVereinsrolle(clubId, role) {
  let permissions = getUserPermissions();
  return isAuthenticated() && permissions.clubId == clubId && permissions.role == role;
}

function isSportleiter(clubId) { return isVereinsrolle(clubId, 'sportleiter'); }
function isKassenwart(clubId) { return isVereinsrolle(clubId, 'kassenwart'); }
function isSchriftfuehrer(clubId) { return isVereinsrolle(clubId, 'schriftfuehrer'); }
function isVorstand(clubId) { return isVereinsrolle(clubId, 'vorstand'); }
function isJugendwart(clubId) { return isVereinsrolle(clubId, 'jugendwart'); }
function isDamenwart(clubId) { return isVereinsrolle(clubId, 'damenwart'); }
```

#### üìñ √ñffentliche Bereiche (Tabellen bleiben √∂ffentlich):
```javascript
// RWK-Tabellen - Komplett √∂ffentlich f√ºr Transparenz
match /seasons/{season} { allow read: if true; }
match /clubs/{club} { allow read: if true; }
match /rwk_leagues/{league} { allow read: if true; }
match /shooters/{shooter} { allow read: if true; }
match /rwk_scores/{score} { allow read: if true; }
match /newsItems/{news} { allow read: if true; }
```

#### üéØ RWK-System (Hybrid-Sicherheit):
```javascript
match /rwk_teams/{team} {
  allow read: if true; // √ñffentlich f√ºr Tabellen
  allow write: if isSuperAdmin() || 
               isSportleiter(resource.data.clubId) || 
               isKvWettkampfleiter(resource.data.kvId);
}

match /rwk_scores/{score} {
  allow read: if true;
  allow create: if isSportleiter(request.resource.data.clubId) && 
                 isValidRingCount(request.resource.data.totalRinge);
  allow update, delete: if isSuperAdmin() || 
                        isKvWettkampfleiter(resource.data.kvId);
}
```

#### üèÜ KM-System (Granulare Kontrolle):
```javascript
match /km_meldungen/{meldung} {
  allow read: if isSuperAdmin() || 
              isKvWettkampfleiter(resource.data.kvId) || 
              isKvKmOrga(resource.data.kvId) ||
              isSportleiter(resource.data.clubId);
  allow write: if isSuperAdmin() || 
               isKvWettkampfleiter(resource.data.kvId) || 
               isKvKmOrga(resource.data.kvId);
}

match /km_startlisten/{startliste} {
  allow read: if true; // √ñffentlich nach Erstellung
  allow write: if isSuperAdmin() || isKvKmOrga(resource.data.kvId);
}
```

#### üè¢ Vereinssoftware (Multi-Tenant + Granular):
```javascript
// Basis-Regel: Vereinsmitglieder k√∂nnen eigene Vereinsdaten lesen
match /clubs/{clubId}/{collection}/{docId} {
  allow read: if isSuperAdmin() || 
              isVorstand(clubId) || 
              isSportleiter(clubId) || 
              isKassenwart(clubId) || 
              isSchriftfuehrer(clubId);
  allow write: if isSuperAdmin() || isVorstand(clubId);
}

// Finanz-Regeln (Nur Kassenwart + Vorstand)
match /clubs/{clubId}/finanzen/{docId} {
  allow read, write: if isSuperAdmin() || 
                     isVorstand(clubId) || 
                     isKassenwart(clubId);
}

// Protokoll-Regeln (Schriftf√ºhrer + Vorstand)
match /clubs/{clubId}/protokolle/{docId} {
  allow read: if isSuperAdmin() || 
              isVorstand(clubId) || 
              isSchriftfuehrer(clubId) ||
              isKassenwart(clubId); // Kann Protokolle lesen
  allow write: if isSuperAdmin() || 
               isVorstand(clubId) || 
               isSchriftfuehrer(clubId);
}

// Mitglieder-Regeln (Erweiterte Lesezugriffe)
match /clubs/{clubId}/mitglieder/{memberId} {
  allow read: if isSuperAdmin() || 
              isVorstand(clubId) || 
              isKassenwart(clubId) || 
              isSchriftfuehrer(clubId) ||
              isSportleiter(clubId); // F√ºr Mannschaftsplanung
  allow write: if isSuperAdmin() || 
               isVorstand(clubId) || 
               isKassenwart(clubId);
}
```

### üì± 5. Dashboard-Auswahl anpassen

#### üéØ Bereiche pro Rolle (Erweiterte Matrix):

**üëë Globale Rollen:**
- [ ] **Super-Admin:** Alle Bereiche + System-Tools
- [ ] **System-Admin:** Alle Bereiche + Wartung
- [ ] **Data-Manager:** Alle Bereiche + Import/Export

**üéØ KV-Rollen:**
- [ ] **KV-Wettkampfleiter:** RWK + KM (Vollzugriff)
- [ ] **KV-KM-Orga:** KM (Vollzugriff) + RWK (Lesezugriff)
- [ ] **KV-Pressewart:** News (Schreibzugriff) + RWK/KM (Lesezugriff)
- [ ] **KV-Kampfrichter:** KM-Ergebnisse + Startlisten

**üè¢ Vereins-Rollen (Sofort):**
- [ ] **Vereinsvorstand:** Alle 3 Bereiche (RWK + KM + Vereinssoftware)
- [ ] **Sportleiter:** RWK + KM (Vollzugriff)
- [ ] **Kassenwart:** Vereinssoftware (Finanzen + Mitglieder)
- [ ] **Schriftf√ºhrer:** Vereinssoftware (Protokolle + Mitglieder-Lesezugriff)

**üéì Erweiterte Rollen (Phase 2):**
- [ ] **Jugendwart:** Vereinssoftware (Jugend-Mitglieder + Ausbildungen)
- [ ] **Damenwart:** Vereinssoftware (Damen-Events + Mitglieder-Filter)
- [ ] **Zeugwart:** Vereinssoftware (Inventar + Waffen-Verwaltung)
- [ ] **Pressewart:** Vereinssoftware (News + Berichte)
- [ ] **Trainer:** Vereinssoftware (Lizenzen + Ausbildungen)
- [ ] **Vereinssch√ºtze:** Vereinssoftware (Eigene Daten + Lesezugriff)

### üß™ 6. Tests durchf√ºhren

#### üé≠ Test-Accounts erstellen (Rollen-Matrix):
- [ ] **Super-Admin-Test:** admin@rwk-einbeck.de (Vollzugriff)
- [ ] **Vereinsvertreter-Test:** marcel.buenger@gmx.de (Legacy-Rolle)
- [ ] **KV-Wettkampfleiter-Test:** Vollzugriff RWK/KM
- [ ] **KV-KM-Orga-Test:** KM-Vollzugriff, RWK-Lesezugriff
- [ ] **Vereinsvorstand-Test:** Alle 3 Bereiche f√ºr eigenen Verein
- [ ] **Sportleiter-Test:** Nur RWK/KM f√ºr eigenen Verein
- [ ] **Kassenwart-Test:** Nur Finanzen/Mitglieder f√ºr eigenen Verein
- [ ] **Schriftf√ºhrer-Test:** Nur Protokolle/Mitglieder-Lesezugriff
- [ ] **Fremder-Verein-Test:** Kein Zugriff auf andere Vereinsdaten

#### üéØ Test-Szenarien (Erweiterte Matrix):

**Dashboard-Tests:**
- [ ] Jede Rolle sieht nur erlaubte Bereiche
- [ ] Gesperrte Bereiche sind ausgegraut
- [ ] Korrekte Weiterleitungen nach Login

**URL-Sicherheit:**
- [ ] Direkte URLs werden f√ºr falsche Rollen blockiert
- [ ] Cross-Verein-Zugriffe werden verhindert
- [ ] API-Endpunkte respektieren Rollen

**Firebase-Rules:**
- [ ] √ñffentliche Tabellen bleiben lesbar
- [ ] Multi-Tenant-Trennung funktioniert
- [ ] Granulare Berechtigungen greifen
- [ ] Keine Privilege-Escalation m√∂glich

**Performance-Tests:**
- [ ] Keine Endlosschleifen bei Rollen-Checks
- [ ] Schnelle Berechtigungs-Validierung
- [ ] Effiziente Firestore-Abfragen

**Cross-Verein-Tests:**
- [ ] Sportleiter A kann nicht Verein B bearbeiten
- [ ] Kassenwart A sieht keine Finanzen von Verein B
- [ ] Schriftf√ºhrer A kann keine Protokolle von Verein B lesen

**API-Endpunkt-Tests:**
- [ ] `/api/clubs/[clubId]/mitglieder` - Rollen-Validierung
- [ ] `/api/clubs/[clubId]/beitraege` - Kassenwart-Only
- [ ] `/api/clubs/[clubId]/protokolle` - Schriftf√ºhrer-Access
- [ ] `/api/rwk/teams` - Sportleiter-Berechtigung
- [ ] `/api/km/meldungen` - KM-Orga-Zugriff

### üìß 7. Kommunikation

#### Benutzer informieren:
- [ ] **E-Mail an alle Benutzer:** Neue Rollen erkl√§ren
- [ ] **FAQ aktualisieren:** Rollen-System dokumentieren
- [ ] **Support bereitstellen:** F√ºr R√ºckfragen

### üîÑ 8. Rollback-Plan (5-Minuten-Notfall)

#### üö® Sofort-Ma√ünahmen bei kritischen Problemen:
- [ ] **LoginBlocker deaktivieren** (1 Min): Kommentar in `/src/app/login/page.tsx`
- [ ] **Firebase-Regeln zur√ºcksetzen** (2 Min): Backup-Rules aus Git deployen
- [ ] **URL-Sicherung entfernen** (1 Min): Berechtigungs-Checks auskommentieren
- [ ] **Dashboard-Sperre aufheben** (1 Min): Alle Bereiche wieder freigeben

#### üìã Rollback-Scripts (Vorbereitet):
```bash
# Notfall-Rollback (5 Minuten)
git checkout HEAD~1 -- firestore.rules
firebase deploy --only firestore:rules

# URL-Sicherung deaktivieren
find src/app -name "*.tsx" -exec sed -i 's/if (!hasAccess/\/\/ if (!hasAccess/g' {} \;

# LoginBlocker ausschalten
sed -i 's/<LoginBlocker/{\/\* <LoginBlocker/g; s/\/>/\*\/}/g' src/app/login/page.tsx
```

#### üéØ Rollback-Priorit√§ten:
1. **Kritisch (0-5 Min):** Login-Zugang wiederherstellen
2. **Hoch (5-15 Min):** Vereinsvertreter-Zugang zu Vereinssoftware
3. **Mittel (15-30 Min):** RWK/KM-Funktionen normalisieren
4. **Niedrig (30+ Min):** Optimierungen und Feintuning

#### üìû Eskalations-Plan:
- **0-5 Min:** Automatische Rollback-Scripts
- **5-15 Min:** Marcel direkt kontaktieren
- **15+ Min:** Wartungsmodus aktivieren, vollst√§ndiger Rollback

---

## üìù Wichtige Dateien

### Bereits erstellt:
- ‚úÖ `/src/components/MaintenanceBanner.tsx` - Wartungshinweis (aktiv)
- ‚úÖ `/src/components/LoginBlocker.tsx` - Login-Sperre (bereit)
- ‚úÖ Alle Multi-Tenant APIs erstellt
- ‚úÖ Alle Vereinssoftware-Bereiche auf Multi-Tenant umgestellt

### Noch zu bearbeiten:
- ‚è≥ Login-Seite (LoginBlocker einbauen)
- ‚è≥ Alle Vereinssoftware-Seiten (URL-Sicherung)
- ‚è≥ Firebase Security Rules
- ‚è≥ Dashboard-Auswahl (Rollen-spezifische Anzeige)

---

## üéØ Ziel

**Nach den Wartungsarbeiten:**
- Saubere Rollen-Trennung
- Sichere URL-Zugriffe  
- Multi-Tenant Vereinssoftware
- Keine Berechtigungs-Lecks

**Gesch√§tzte Dauer:** 3-6 Stunden (erweiterte Rollen-Matrix)

**Phasen-Plan:**
- **Phase 1 (1h):** Login-Sperre + Basis-Rollen (Sportleiter, Kassenwart, Schriftf√ºhrer, Vorstand)
- **Phase 2 (2h):** Firebase-Rules + URL-Sicherung + Tests
- **Phase 3 (1h):** Dashboard-Anpassung + Cross-Verein-Tests
- **Phase 4 (1h):** Performance-Tests + Dokumentation
- **Puffer (1h):** Unvorhergesehene Probleme + Rollback-Tests

---

## üìû Kontakt

Bei Problemen w√§hrend der Wartung:
- **Marcel:** marcel.buenger@gmx.de
- **Entwickler:** Verf√ºgbar f√ºr Support

---

---

## üîÑ √Ñnderungen seit Version 1.5.7 (11.09.2025)

### ‚úÖ Bereits implementiert:
- **MaintenanceBanner** auf Startseite aktiviert (Wartungshinweis ab sofort sichtbar)
- **LoginBlocker** erstellt (bereit f√ºr 15.09.)
- **Dashboard-Auswahl** angepasst: Vereinsvertreter sehen Vereinssoftware als gesperrt
- **Console.log Endlosschleife** in Dashboard behoben
- **Wartungshinweis** vereinfacht (keine Rollen-Details, keine Zeitangaben)
- **Vereinsvertreter-Zugang** zur Vereinssoftware √ºber Dashboard entfernt
- **URL-Zugriffe** noch offen (f√ºr Entwicklung bis 15.09.)

### üìã Status der Vorbereitung:
- ‚úÖ **Wartungshinweis:** L√§uft bereits
- ‚úÖ **LoginBlocker:** Bereit, aber noch nicht aktiv
- ‚úÖ **Dashboard-Sperre:** Funktioniert
- ‚è≥ **URL-Sicherung:** Wartet auf 15.09.
- ‚è≥ **Rollen-Umstellung:** Wartet auf 15.09.
- ‚è≥ **Firebase-Regeln:** Wartet auf 15.09.

### üéØ Aktueller Stand:
- **Benutzer sehen:** Wartungshinweis auf Startseite
- **Vereinsvertreter:** K√∂nnen nicht mehr √ºber Dashboard zur Vereinssoftware
- **Direkte URLs:** Funktionieren noch (f√ºr Entwicklung)
- **System:** Bereit f√ºr Rollen-Revolution am 15.09.

### üöÄ Langfristige Vision (Post-Wartung):
- **Multi-Verband-F√§higkeit:** Andere Kreisverb√§nde k√∂nnen eigene Instanzen nutzen
- **Vereins-Autonomie:** Jeder Verein hat komplett getrennte Daten
- **API-Schnittstellen:** Externe Tools k√∂nnen sicher andocken
- **Skalierungs-Bereitschaft:** Von 15 auf 150+ Vereine erweiterbar
- **Compliance-Ready:** DSGVO-konforme Multi-Tenant-Architektur

---

**Erstellt am:** 11.09.2025  
**Wartungstermin:** 15.09.2025  
**Status:** Vorbereitet ‚úÖ