rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // === HELPER FUNCTIONS (AdminSDK + 3-Ebenen-Architektur) ===
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserPermissions() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/user_permissions/$(request.auth.uid)) ?
             get(/databases/$(database)/documents/user_permissions/$(request.auth.uid)).data : null;
    }

    // 👑 Globale Rollen
    function isSuperAdmin() {
      return request.auth != null && 
             (request.auth.token.email == 'admin@rwk-einbeck.de' ||
              (getUserPermissions() != null && getUserPermissions().platformRole == 'SUPER_ADMIN'));
    }
    
    // TEMPORÄR: Direkte E-Mail-Prüfung für Admin
    function isAdminEmail() {
      return request.auth != null && request.auth.token.email == 'admin@rwk-einbeck.de';
    }
    
    function isSystemAdmin() {
      return isAuthenticated() && 
             getUserPermissions() != null && 
             getUserPermissions().platformRole == 'SYSTEM_ADMIN';
    }
    
    function isDataManager() {
      return isAuthenticated() && 
             getUserPermissions() != null && 
             getUserPermissions().platformRole == 'DATA_MANAGER';
    }

    // 🎯 KV-Rollen
    function getUserKvRole(kvId) {
      return isAuthenticated() && getUserPermissions() != null && getUserPermissions().kvRoles != null ?
             getUserPermissions().kvRoles[kvId] : null;
    }

    function isKvWettkampfleiter(kvId) {
      return getUserKvRole(kvId) == 'KV_WETTKAMPFLEITER';
    }
    
    function isKvKmOrga(kvId) {
      return getUserKvRole(kvId) == 'KV_KM_ORGA';
    }
    
    function isKvPressewart(kvId) {
      return getUserKvRole(kvId) == 'KV_PRESSEWART';
    }
    
    function isKvKampfrichter(kvId) {
      return getUserKvRole(kvId) == 'KV_KAMPFRICHTER';
    }

    // 🏢 Vereins-Rollen (Neue Struktur)
    function getUserClubRole(clubId) {
      return isAuthenticated() && getUserPermissions() != null && getUserPermissions().clubRoles != null ?
             getUserPermissions().clubRoles[clubId] : null;
    }

    function isVorstand(clubId) { 
      return getUserClubRole(clubId) == 'VORSTAND'; 
    }
    
    function isSportleiter(clubId) { 
      return getUserClubRole(clubId) == 'SPORTLEITER'; 
    }
    
    function isKassenwart(clubId) { 
      return getUserClubRole(clubId) == 'KASSENWART'; 
    }
    
    function isSchriftfuehrer(clubId) { 
      return getUserClubRole(clubId) == 'SCHRIFTFUEHRER'; 
    }
    
    function isJugendwart(clubId) { 
      return getUserClubRole(clubId) == 'JUGENDWART'; 
    }
    
    function isDamenwart(clubId) { 
      return getUserClubRole(clubId) == 'DAMENWART'; 
    }
    
    function isZeugwart(clubId) { 
      return getUserClubRole(clubId) == 'ZEUGWART'; 
    }
    
    function isPressewart(clubId) { 
      return getUserClubRole(clubId) == 'PRESSEWART'; 
    }

    function isTrainer(clubId) { 
      return getUserClubRole(clubId) == 'TRAINER'; 
    }

    function isAusbilder(clubId) { 
      return getUserClubRole(clubId) == 'AUSBILDER'; 
    }

    function isVereinsschuetze(clubId) { 
      return getUserClubRole(clubId) == 'VEREINSSCHUETZE'; 
    }

    function isEhrenmitglied(clubId) { 
      return getUserClubRole(clubId) == 'EHRENMITGLIED'; 
    }

    // Legacy-Support (Übergangszeit)
    function hasLegacyClubAccess(clubId) {
      return isAuthenticated() && 
             getUserPermissions() != null && 
             (getUserPermissions().role == 'vereinsvertreter' || getUserPermissions().role == 'mannschaftsfuehrer') &&
             (getUserPermissions().clubId == clubId || getUserPermissions().assignedClubId == clubId);
    }
    
    function isMannschaftsfuehrer(clubId) {
      return getUserClubRole(clubId) == 'MANNSCHAFTSFUEHRER';
    }
    
    function isLegacyMannschaftsfuehrer() {
      return isAuthenticated() && 
             getUserPermissions() != null && 
             getUserPermissions().role == 'mannschaftsfuehrer';
    }

    function hasClubAccess(clubId) {
      return isSuperAdmin() || 
             getUserClubRole(clubId) != null ||
             hasLegacyClubAccess(clubId);
    }

    function canWriteClub(clubId) {
      return isSuperAdmin() || 
             isVorstand(clubId) ||
             hasLegacyClubAccess(clubId); // Legacy
    }

    function canReadFinances(clubId) {
      return isSuperAdmin() || 
             isVorstand(clubId) || 
             isKassenwart(clubId) ||
             hasLegacyClubAccess(clubId); // Legacy
    }

    function canWriteFinances(clubId) {
      return isSuperAdmin() || 
             isVorstand(clubId) || 
             isKassenwart(clubId) ||
             hasLegacyClubAccess(clubId); // Legacy
    }

    // 🎓 Erweiterte Berechtigungen
    function canAccessLicenses(clubId) {
      return isSuperAdmin() || 
             isVorstand(clubId) ||
             isSportleiter(clubId) ||
             isTrainer(clubId) ||
             isAusbilder(clubId) ||
             hasLegacyClubAccess(clubId);
    }

    function canAccessJubilees(clubId) {
      return isSuperAdmin() || 
             isVorstand(clubId) ||
             isKassenwart(clubId) ||
             isSchriftfuehrer(clubId) ||
             hasLegacyClubAccess(clubId);
    }

    function canAccessTasks(clubId) {
      return isSuperAdmin() || 
             isVorstand(clubId) ||
             hasLegacyClubAccess(clubId);
    }

    function canReadMembers(clubId) {
      return isSuperAdmin() || 
             isVorstand(clubId) || 
             isKassenwart(clubId) || 
             isSchriftfuehrer(clubId) ||
             isSportleiter(clubId) || // Mannschaftsplanung
             isMannschaftsfuehrer(clubId) || // Mannschaftsplanung
             isJugendwart(clubId) ||
             isDamenwart(clubId) ||
             hasLegacyClubAccess(clubId); // Legacy
    }

    function canWriteMembers(clubId) {
      return isSuperAdmin() || 
             isVorstand(clubId) || 
             isKassenwart(clubId) ||
             isSportleiter(clubId) || // SPORTLEITER kann Mitglieder bearbeiten
             hasLegacyClubAccess(clubId); // Legacy
    }

    function canReadProtocols(clubId) {
      return isSuperAdmin() || 
             isVorstand(clubId) || 
             isSchriftfuehrer(clubId) ||
             isKassenwart(clubId) || // Kann lesen
             hasLegacyClubAccess(clubId); // Legacy
    }

    function canWriteProtocols(clubId) {
      return isSuperAdmin() || 
             isVorstand(clubId) || 
             isSchriftfuehrer(clubId) ||
             hasLegacyClubAccess(clubId); // Legacy
    }

    function isValidRingCount(rings) {
      return rings is number && rings >= 0 && rings <= 600;
    }

    // === ÖFFENTLICHE BEREICHE ===
    
    match /seasons/{season} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /clubs/{club} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /rwk_leagues/{league} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /shooters/{shooter} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isSuperAdmin() || 
                    hasLegacyClubAccess(resource.data.clubId) || // Legacy
                    hasClubAccess(resource.data.clubId);
      allow delete: if false; // NUR über AdminSDK-API
    }

    match /newsItems/{news} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /rwk_news/{news} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // === RWK-SYSTEM ===
    
    match /rwk_teams/{team} {
      allow read: if true;
      allow create: if isSuperAdmin() || 
                    hasLegacyClubAccess(request.resource.data.clubId) || // Legacy
                    isSportleiter(request.resource.data.clubId) ||
                    isVorstand(request.resource.data.clubId);
      allow update, delete: if isSuperAdmin() || 
                            hasLegacyClubAccess(resource.data.clubId) || // Legacy
                            isSportleiter(resource.data.clubId) ||
                            isVorstand(resource.data.clubId);
    }

    match /rwk_scores/{score} {
      allow read: if true;
      allow create: if isAuthenticated() && 
                    isValidRingCount(request.resource.data.totalRinge) &&
                    (isSuperAdmin() || 
                     isMannschaftsfuehrer(request.resource.data.clubId) ||
                     isLegacyMannschaftsfuehrer() || 
                     hasLegacyClubAccess(request.resource.data.clubId));
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    // === KM-SYSTEM ===
    
    match /km_meldungen/{meldung} {
      allow read: if true;
      allow write: if isSuperAdmin() || 
                   hasLegacyClubAccess(resource.data.clubId) || // Legacy
                   isSportleiter(resource.data.clubId) ||
                   isVorstand(resource.data.clubId);
    }

    match /{collection}/{document=**} {
      allow read: if true && collection.matches('km_meldungen_.*');
      allow write: if isSuperAdmin() && collection.matches('km_meldungen_.*');
    }

    // === VEREINSSOFTWARE (Multi-Tenant + Granular) ===
    
    // 👥 Mitgliederverwaltung - Erweiterte Lesezugriffe
    match /clubs/{clubId}/mitglieder/{member} {
      allow read: if canReadMembers(clubId);
      allow write: if canWriteMembers(clubId);
    }

    // 💰 Finanzen & Beiträge - Nur Kassenwart + Vorstand
    match /clubs/{clubId}/finanzen/{finance} {
      allow read: if canReadFinances(clubId);
      allow write: if canWriteFinances(clubId);
    }

    match /clubs/{clubId}/beitraege/{beitrag} {
      allow read: if canReadFinances(clubId);
      allow write: if canWriteFinances(clubId);
    }

    match /clubs/{clubId}/sepa/{sepa} {
      allow read: if canReadFinances(clubId);
      allow write: if canWriteFinances(clubId);
    }

    // ⚖️ Protokolle & Vereinsrecht - Schriftführer + Vorstand
    match /clubs/{clubId}/protokolle/{protokoll} {
      allow read: if canReadProtocols(clubId);
      allow write: if canWriteProtocols(clubId);
    }

    match /clubs/{clubId}/vereinsrecht_protokolle/{protokoll} {
      allow read: if canReadProtocols(clubId);
      allow write: if canWriteProtocols(clubId);
    }

    match /clubs/{clubId}/wahlen/{wahl} {
      allow read: if canReadProtocols(clubId);
      allow write: if canWriteProtocols(clubId);
    }

    match /clubs/{clubId}/satzung/{satzung} {
      allow read: if canReadProtocols(clubId);
      allow write: if canWriteProtocols(clubId);
    }

    // 📋 Aufgaben-Management - Nur Vorstand
    match /clubs/{clubId}/aufgaben/{task} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId) ||
                         hasLegacyClubAccess(clubId);
    }

    // 🏆 Lizenzen & Ausbildungen - Sportleiter + Vorstand + Trainer
    match /clubs/{clubId}/lizenzen/{lizenz} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId) ||
                         isSportleiter(clubId) ||
                         isTrainer(clubId) ||
                         isAusbilder(clubId) ||
                         hasLegacyClubAccess(clubId);
    }

    match /clubs/{clubId}/ausbildungen/{ausbildung} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId) ||
                         isSportleiter(clubId) ||
                         isTrainer(clubId) ||
                         isAusbilder(clubId) ||
                         hasLegacyClubAccess(clubId);
    }

    // 🎂 Geburtstage & Jubiläen - Vorstand, Kassenwart, Schriftführer
    match /clubs/{clubId}/jubilaeen/{jubilaeum} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId) ||
                         isKassenwart(clubId) ||
                         isSchriftfuehrer(clubId) ||
                         hasLegacyClubAccess(clubId);
    }

    match /clubs/{clubId}/geburtstage/{geburtstag} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId) ||
                         isKassenwart(clubId) ||
                         isSchriftfuehrer(clubId) ||
                         hasLegacyClubAccess(clubId);
    }

    // 🎓 Erweiterte Rollen (Phase 2)
    match /clubs/{clubId}/jugend/{jugend} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId) ||
                         isJugendwart(clubId) ||
                         hasLegacyClubAccess(clubId);
    }

    match /clubs/{clubId}/damen/{damen} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId) ||
                         isDamenwart(clubId) ||
                         hasLegacyClubAccess(clubId);
    }

    match /clubs/{clubId}/inventar/{inventar} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId) ||
                         isZeugwart(clubId) ||
                         hasLegacyClubAccess(clubId);
    }

    match /clubs/{clubId}/waffen/{waffe} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId) ||
                         isZeugwart(clubId) ||
                         hasLegacyClubAccess(clubId);
    }

    match /clubs/{clubId}/news/{news} {
      allow read: if hasClubAccess(clubId);
      allow write: if isSuperAdmin() || 
                   isVorstand(clubId) ||
                   isPressewart(clubId) ||
                   hasLegacyClubAccess(clubId);
    }

    match /clubs/{clubId}/berichte/{bericht} {
      allow read: if hasClubAccess(clubId);
      allow write: if isSuperAdmin() || 
                   isVorstand(clubId) ||
                   isPressewart(clubId) ||
                   hasLegacyClubAccess(clubId);
    }

    // 🔒 Fallback für alle anderen Club-Dokumente
    match /clubs/{clubId}/{document=**} {
      allow read: if hasClubAccess(clubId);
      allow write: if canWriteClub(clubId);
    }

    // === E-MAIL SYSTEM ===
    
    match /email_contacts/{document} {
      allow read, write: if request.auth != null && (
        // Super-Admin
        request.auth.token.email == 'admin@rwk-einbeck.de' ||
        // Benutzer mit Admin-Berechtigung in user_permissions
        exists(/databases/$(database)/documents/user_permissions/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/user_permissions/$(request.auth.uid)).data.keys().hasAny(['role', 'clubRoles', 'kvRole']) &&
        (
          get(/databases/$(database)/documents/user_permissions/$(request.auth.uid)).data.role == 'superadmin' ||
          get(/databases/$(database)/documents/user_permissions/$(request.auth.uid)).data.kvRole in ['KV_WETTKAMPFLEITER'] ||
          get(/databases/$(database)/documents/user_permissions/$(request.auth.uid)).data.clubRoles != null &&
          get(/databases/$(database)/documents/user_permissions/$(request.auth.uid)).data.clubRoles.keys().size() > 0 &&
          get(/databases/$(database)/documents/user_permissions/$(request.auth.uid)).data.clubRoles.values().hasAny(['SPORTLEITER', 'VORSTAND'])
        )
      );
    }

    match /email_history/{document} {
      allow read, write: if isSuperAdmin() || 
                         (isAuthenticated() && getUserPermissions() != null && 
                          (getUserPermissions().kvRole == 'KV_WETTKAMPFLEITER' ||
                           (getUserPermissions().clubRoles != null && 
                            getUserPermissions().clubRoles.values().hasAny(['SPORTLEITER', 'VORSTAND']))));
    }

    match /email_templates/{document} {
      allow read, write: if isSuperAdmin() || 
                         (isAuthenticated() && getUserPermissions() != null && 
                          (getUserPermissions().kvRole == 'KV_WETTKAMPFLEITER' ||
                           (getUserPermissions().clubRoles != null && 
                            getUserPermissions().clubRoles.values().hasAny(['SPORTLEITER', 'VORSTAND']))));
    }

    match /admin_settings/{document} {
      allow read, write: if request.auth.token.email == 'admin@rwk-einbeck.de';
    }

    match /system_config/{document} {
      allow read, write: if request.auth.token.email == 'admin@rwk-einbeck.de';
    }

    match /app_stats/{document} {
      allow read, write: if request.auth.token.email == 'admin@rwk-einbeck.de';
    }

    // === SUPPORT SYSTEM ===
    
    match /support_sessions/{document} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.clubId != null && hasClubAccess(resource.data.clubId));
      allow create: if isAuthenticated() && hasClubAccess(request.resource.data.clubId);
      allow update: if isSuperAdmin() || 
                    (isAuthenticated() && resource.data.clubId != null && hasClubAccess(resource.data.clubId));
      allow delete: if isSuperAdmin();
    }



    // === SYSTEM & ADMIN ===
    
    match /user_permissions/{userId} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && request.auth.uid == userId);
      allow write: if isSuperAdmin();
    }

    match /users/{userId} {
      allow read: if isSuperAdmin();
      allow write: if isSuperAdmin() || 
                   (isAuthenticated() && request.auth.uid == userId);
    }

    match /audit_logs/{log} {
      allow read: if isSuperAdmin();
      allow create: if true; // AdminSDK erstellt Logs
      allow update, delete: if false;
    }

    // === LEGACY & FALLBACK ===
    
    match /events/{event} {
      allow read: if true;
      allow create, update: if isAuthenticated();
      allow delete: if isSuperAdmin();
    }

    match /support_tickets/{ticket} {
      allow create: if true;
      allow read, update, delete: if isSuperAdmin();
    }

    match /protests/{protest} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.submittedBy == request.auth.token.email);
      allow create: if isAuthenticated();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    match /updates/{update} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /league_updates/{update} {
      allow read: if true;
      allow create, update: if isSuperAdmin() || 
                            isMannschaftsfuehrer(request.resource.data.clubId) ||
                            isLegacyMannschaftsfuehrer() || 
                            hasLegacyClubAccess(request.resource.data.clubId);
      allow delete: if isSuperAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}