rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // === HELPER FUNCTIONS (3-Ebenen-Architektur) ===
    
    // 👑 Globale Rollen
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.email == 'marcel.buenger@gmx.de';
    }
    
    function isSystemAdmin() {
      return isAuthenticated() && getUserRole() == 'system_admin';
    }
    
    function isDataManager() {
      return isAuthenticated() && getUserRole() == 'data_manager';
    }

    // 🎯 KV-Rollen
    function isKvWettkampfleiter(kvId) {
      return isAuthenticated() && getUserKvRole(kvId) == 'kv_wettkampfleiter';
    }
    
    function isKvKmOrga(kvId) {
      return isAuthenticated() && getUserKvRole(kvId) == 'kv_km_orga';
    }
    
    function isKvPressewart(kvId) {
      return isAuthenticated() && getUserKvRole(kvId) == 'kv_pressewart';
    }

    // 🏢 Vereins-Rollen (Granular)
    function isVereinsrolle(clubId, role) {
      let permissions = getUserPermissions();
      return isAuthenticated() && 
             permissions != null && 
             permissions.clubRoles != null &&
             permissions.clubRoles[clubId] == role;
    }

    function isSportleiter(clubId) { 
      return isVereinsrolle(clubId, 'sportleiter'); 
    }
    
    function isKassenwart(clubId) { 
      return isVereinsrolle(clubId, 'kassenwart'); 
    }
    
    function isSchriftfuehrer(clubId) { 
      return isVereinsrolle(clubId, 'schriftfuehrer'); 
    }
    
    function isVorstand(clubId) { 
      return isVereinsrolle(clubId, 'vorstand'); 
    }

    // 🔧 Basis-Funktionen
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserPermissions() {
      return get(/databases/$(database)/documents/user_permissions/$(request.auth.uid)).data;
    }

    function getUserRole() {
      return getUserPermissions().platformRole;
    }

    function getUserKvRole(kvId) {
      let permissions = getUserPermissions();
      return permissions.kvRoles != null ? permissions.kvRoles[kvId] : null;
    }

    function hasClubAccess(clubId) {
      return isSuperAdmin() || 
             isVorstand(clubId) || 
             isSportleiter(clubId) || 
             isKassenwart(clubId) || 
             isSchriftfuehrer(clubId);
    }

    // === ÖFFENTLICHE BEREICHE (Tabellen bleiben öffentlich) ===
    
    match /seasons/{season} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /clubs/{club} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /rwk_leagues/{league} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /shooters/{shooter} {
      allow read: if true;
      allow write: if isSuperAdmin() || isAuthenticated(); // Für Team-Operationen
    }

    match /newsItems/{news} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // === RWK-SYSTEM (Hybrid-Sicherheit) ===
    
    match /rwk_teams/{team} {
      allow read: if true; // Öffentlich für Tabellen
      allow write: if isSuperAdmin() || 
                   isSportleiter(resource.data.clubId) ||
                   isVorstand(resource.data.clubId);
    }

    match /rwk_scores/{score} {
      allow read: if true;
      allow create: if isAuthenticated() && 
                    request.resource.data.totalRinge is number &&
                    request.resource.data.totalRinge >= 0 &&
                    request.resource.data.totalRinge <= 600;
      allow update, delete: if isSuperAdmin();
    }

    match /rwk_team_shooters/{assignment} {
      allow read: if true;
      allow write: if isSuperAdmin() || 
                   hasClubAccess(resource.data.clubId);
    }

    match /rwk_shooter_team_assignments/{assignment} {
      allow read: if true;
      allow write: if isSuperAdmin() || 
                   hasClubAccess(resource.data.clubId);
    }

    // === KM-SYSTEM (Granulare Kontrolle) ===
    
    match /km_meldungen/{meldung} {
      allow read: if true; // Öffentlich nach Erstellung
      allow write: if isSuperAdmin() || 
                   isSportleiter(resource.data.clubId) ||
                   isVorstand(resource.data.clubId);
    }

    match /km_startlisten/{startliste} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /km_ergebnisse/{ergebnis} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // Alle KM-Collections (Regex-Pattern)
    match /{collection}/{document=**} {
      allow read: if true && collection.matches('km_.*');
      allow write: if isSuperAdmin() && collection.matches('km_.*');
    }

    // === VEREINSSOFTWARE (Multi-Tenant + Granular) ===
    
    // Basis-Regel: Vereinsmitglieder können eigene Vereinsdaten lesen
    match /clubs/{clubId}/mitglieder/{member} {
      allow read: if isSuperAdmin() || 
                  isVorstand(clubId) || 
                  isKassenwart(clubId) || 
                  isSchriftfuehrer(clubId) ||
                  isSportleiter(clubId); // Für Mannschaftsplanung
      allow write: if isSuperAdmin() || 
                   isVorstand(clubId) || 
                   isKassenwart(clubId);
    }

    match /clubs/{clubId}/finanzen/{finance} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId) || 
                         isKassenwart(clubId);
    }

    match /clubs/{clubId}/beitraege/{beitrag} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId) || 
                         isKassenwart(clubId);
    }

    match /clubs/{clubId}/protokolle/{protokoll} {
      allow read: if isSuperAdmin() || 
                  isVorstand(clubId) || 
                  isSchriftfuehrer(clubId) ||
                  isKassenwart(clubId); // Kann Protokolle lesen
      allow write: if isSuperAdmin() || 
                   isVorstand(clubId) || 
                   isSchriftfuehrer(clubId);
    }

    match /clubs/{clubId}/aufgaben/{task} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId);
    }

    match /clubs/{clubId}/lizenzen/{lizenz} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId);
    }

    match /clubs/{clubId}/jubilaeen/{jubilaeum} {
      allow read, write: if isSuperAdmin() || 
                         isVorstand(clubId);
    }

    // Catch-all für alle anderen Club-Collections
    match /clubs/{clubId}/{document=**} {
      allow read: if isSuperAdmin() || hasClubAccess(clubId);
      allow write: if isSuperAdmin() || isVorstand(clubId);
    }

    // === SYSTEM & ADMIN ===
    
    match /user_permissions/{userId} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && request.auth.uid == userId);
      allow write: if isSuperAdmin();
    }

    match /users/{userId} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && request.auth.uid == userId);
      allow write: if isSuperAdmin();
    }

    // === LEGACY & TEMPORÄRE COLLECTIONS ===
    
    match /events/{event} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /league_updates/{update} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /support_tickets/{ticket} {
      allow create: if true;
      allow read, write: if isSuperAdmin();
    }

    match /audit_logs/{log} {
      allow read: if isSuperAdmin();
      allow create: if isAuthenticated();
    }

    match /documents/{doc} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /protests/{protest} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.submittedBy == request.auth.token.email);
      allow create: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // === FALLBACK ===
    
    // Alles andere verbieten
    match /{document=**} {
      allow read, write: if false;
    }
  }
}